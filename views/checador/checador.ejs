<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reloj Checador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style>
        /* Cristal animado para los paneles */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Para que el ID largo no se salga del cuadro */
        .break-all {
            word-break: break-all;
        }
    </style>
</head>

<body class="bg-slate-900 min-h-screen flex items-center justify-center font-sans p-4">

    <div id="check-panel" class="hidden w-full max-w-md animate__animated animate__fadeIn">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-indigo-100">
            <div class="bg-indigo-600 p-8 text-white text-center">
                <h1 class="text-2xl font-black tracking-tighter uppercase">Estaci贸n de Registro</h1>
                <p id="reloj" class="text-3xl font-mono mt-2 text-indigo-200">00:00:00</p>
            </div>

            <div class="p-8 space-y-5">
                <div>
                    <label class="block text-[10px] font-bold text-indigo-600 uppercase mb-1 ml-1">Usuario</label>
                    <input type="text" id="user-input" placeholder="Tu usuario"
                        class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:border-indigo-500 outline-none transition-all">
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-indigo-600 uppercase mb-1 ml-1">C贸digo de
                        Validaci贸n</label>
                    <input type="text" id="otp-input" maxlength="6" placeholder="000000"
                        class="w-full text-center text-3xl font-bold tracking-[0.5rem] p-4 bg-indigo-50 border-2 border-indigo-100 rounded-2xl focus:border-indigo-500 outline-none text-indigo-900">
                </div>

                <button onclick="registrarAsistencia()" id="btn-registrar"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-5 rounded-2xl shadow-xl transform active:scale-95 transition-all flex items-center justify-center">
                    <span>REGISTRAR ASISTENCIA</span>
                    <i class="fas fa-fingerprint ml-3 text-xl"></i>
                </button>
            </div>

            <div class="bg-gray-50 p-4 border-t text-center">
                <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest">
                    <span id="hw-id" class="text-indigo-400 break-all">CARGANDO...</span>
                </p>
            </div>
        </div>
    </div>

    <div id="registration-panel"
        class="hidden w-full max-w-2xl mx-auto p-8 glass-card rounded-3xl border border-red-500/30">
        <h3 class="text-indigo-400 font-bold mb-4"> Equipo no reconocido</h3>

        <div class="space-y-6">
            <div>
                <label class="block text-[10px] font-mono text-indigo-600 uppercase mb-2 ml-1">
                    Identificador del equipo (UUID + Fingerprint)
                </label>
                <textarea id="otp-hwgen" readonly
                    class="w-full p-4 bg-slate-900/50 border-2 border-indigo-100/20 rounded-2xl focus:border-indigo-500 outline-none text-indigo-300 font-mono text-xs break-all h-24 resize-none"></textarea>

                <button onclick="copiarID()"
                    class="mt-2 text-[10px] text-indigo-400 hover:text-white transition-colors">
                    <i class="fas fa-copy mr-1"></i> COPIAR IDENTIFICADOR
                </button>
            </div>

            <div>
                <label class="block text-[10px] font-mono text-indigo-600 uppercase mb-2 ml-1">C贸digo de
                    Vinculaci贸n</label>
                <input type="text" id="vinculacion-input" maxlength="11" placeholder="Ingresa el c贸digo"
                    class="w-full text-center text-2xl font-bold p-4 bg-indigo-50 border-2 border-indigo-100 rounded-2xl focus:border-indigo-500 outline-none text-indigo-900">
            </div>

            <button onclick="solicitarVinculacion()"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-lg transition-all transform active:scale-95">
                VINCULAR AHORA
            </button>
        </div>
    </div>


    <script>

        // 1. Intentar obtener el ID que ya est谩 guardado
        //localStorage.removeItem('relojchecador_uuid');        
        let hwID = localStorage.getItem('relojchecador_uuid');

        console.log("-------------------------------");
        // 3. Funci贸n para enviar los datos a la API
        async function registrarAsistencia() {
            //const email = document.getElementById('user-email').value;
            const codigo = document.getElementById('otp-input').value;
            const usuario = document.getElementById('user-input').value;
            //const btn = document.getElementById('btn-registrar');            

            if (codigo.length < 6) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Codigo invalido',
                    text: 'Por favor, aseg煤rate de digitar el codigo correctamente.',
                    confirmButtonColor: '#4f46e5'
                });
                return;
            }

            // Feedback visual de carga
            Swal.fire({
                title: 'Validando...',
                html: 'Estamos verificando tu identidad y dispositivo',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading() }
            });

            try {
                const response = await fetch('/api/registrar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': '<%= userData.API_KEY %>',
                    },
                    body: JSON.stringify({
                        usuarioClave: usuario,
                        codigoIngresado: codigo,
                        uidDispositivo: hwID,
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: '隆Asistencia Registrada!',
                        text: data.message,
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        showClass: { popup: 'animate__animated animate__fadeInUp' }
                    });
                    document.getElementById('otp-input').value = "";
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Acceso Denegado',
                        text: data.message,
                        confirmButtonColor: '#ef4444'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de servidor',
                    text: 'No pudimos conectar con el reloj checador.',
                });
            }
        }


        // 1. Funci贸n para validar el equipo al entrar
        async function actualizarHardware() {

            try {
                // Aseguramos que hwID no sea nulo antes de la petici贸n
                if (!hwID) {
                    const nuevoID = self.crypto.randomUUID() + "-" + generateHardwareFingerprint();
                    localStorage.setItem('relojchecador_uuid', nuevoID);
                    hwID = nuevoID;
                }


                const response = await fetch('/api/hw/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // El ?. evita errores si userData no llega del servidor
                        'x-api-key': '<%= userData.API_KEY %>',
                    },
                    body: JSON.stringify({ uidDispositivo: hwID })
                });

                const data = await response.json();

                // USAMOS ELEMENTOS CON "?" PARA QUE NO TRUENE SI NO LOS ENCUENTRA
                const checkPanel = document.getElementById('check-panel');
                const regPanel = document.getElementById('registration-panel');

                if (data.success) {
                    checkPanel?.classList.remove('hidden');
                    regPanel?.classList.add('hidden');
                } else {
                    checkPanel?.classList.add('hidden');
                    regPanel?.classList.remove('hidden');

                    // Actualizamos el input con el ID para que te lo puedan mandar
                    const inputHw = document.getElementById('otp-hwgen');
                    if (inputHw) inputHw.value = hwID; // 
                }
            } catch (error) {
                console.error("Error de conexi贸n:", error); // 
                // Si hay error de red, mostramos el panel de registro para no dejar la pantalla en negro
                document.getElementById('registration-panel')?.classList.remove('hidden');
            }
        }


        function generateHardwareFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const txt = 'Prestodin_Security_Check_2024';

            // Configuraciones que var铆an seg煤n el hardware/pantalla
            ctx.textBaseline = "top";
            ctx.font = "14px 'Arial'";
            ctx.textBaseline = "alphabetic";
            ctx.fillStyle = "#f60";
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = "#069";
            ctx.fillText(txt, 2, 15);
            ctx.fillStyle = "rgba(102, 204, 0, 0.7)";
            ctx.fillText(txt, 4, 17);

            // Convertimos el dibujo en una cadena de texto 煤nica (Base64)
            const b64 = canvas.toDataURL().replace("data:image/png;base64,", "");

            // Un simple hash para acortar el resultado
            let hash = 0;
            for (let i = 0; i < b64.length; i++) {
                const char = b64.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convertir a 32bit integer
            }
            return Math.abs(hash);
        }



        // 3. Funci贸n para copiar el ID al portapapeles
        function copiarID() {
            const idText = document.getElementById('otp-hwgen');
            const textArea = document.createElement('textarea');
            textArea.value = idText.value;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);

            // Peque帽o feedback visual
            const originalText = idText.innerText;
            idText.innerText = "隆Copiado!";
            setTimeout(() => {
                idText.innerText = originalText;
            }, 2000);
        }


        // 2. Reloj    
        setInterval(() => {
            document.getElementById('reloj').innerText = new Date().toLocaleTimeString();
        }, 1000);


        // 2. Manejo de par谩metros de URL al cargar
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const emailDesdeUrl = params.get('u');
            const codigoDesdeUrl = params.get('c');

            if (emailDesdeUrl) {
                document.getElementById('user-input').value = emailDesdeUrl;
            }
            if (codigoDesdeUrl) {
                document.getElementById('otp-input').value = codigoDesdeUrl; // <--- CORREGIDO: Ahora s铆 pone el c贸digo
            }

            // Ejecutamos la validaci贸n de hardware
            actualizarHardware();
        });


    </script>






</body>

</html>